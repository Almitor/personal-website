# 单点登录

Single Sign-On	SSO

SSO是一种**身份认证**解决方案，在多个相关但独立的系统中，只需要登录一次，就可以访问其他相互信任的系统，如登录了淘宝，天猫就不用二次登录，退出账号同理，这种集中式的身份验证模型极大提升了用户体验，减轻了用户负担，同时也提高了整个系统的安全性

## 原理

### 基于Cookie的SSO

浏览器的 Cookie 在同一顶级域名下的多个子域名之间共享用户的认证信息，例如 `a.test.com` 和 `b.test.com`，但不能跨不同的域名，

**用户访问应用 A**

- 用户通过浏览器访问应用 A (`a.test.com`)。
- 应用 A 检查用户的请求，发现没有携带有效的认证 Cookie，于是将用户重定向到 SSO 认证中心 (`auth.test.com`)。

**重定向到 SSO 认证中心**

- 浏览器重定向到 SSO 认证中心 (`auth.test.com`)。
- SSO 认证中心显示登录页面，用户输入用户名和密码进行登录。

**用户登录认证**

- SSO 认证中心验证用户提供的凭据（用户名和密码）。
- 如果认证成功，SSO 认证中心生成一个会话 Cookie，并设置在**顶级域名**下（例如 `.test.com`），这样所有子域名（如 `a.test.com` 和 `b.test.com`）都可以访问这个 Cookie。
- SSO 认证中心将用户重定向回最初访问的应用 A (`a.test.com`)。

**应用 A 验证 Cookie**

- 浏览器在请求头中携带 SSO 认证中心设置的 Cookie 访问应用 A (`a.test.com`)。
- 应用 A 读取并验证该 Cookie，如果 Cookie 有效，应用 A 知道用户已经通过认证，允许访问受保护的资源。
- 应用 A 可以选择将用户信息存储在服务器会话中，或者继续依赖该 Cookie 进行用户身份验证。

**用户访问应用 B**

- 用户接下来访问应用 B (`b.test.com`)。
- 浏览器同样会携带顶级域名下的共享 Cookie 进行请求。
- 应用 B 读取并验证该 Cookie，确认用户已经通过认证，允许用户访问受保护的资源。

**用户登出**

- 用户在任何一个应用（如应用 A）中执行登出操作。
- 应用 A 将请求发送到 SSO 认证中心，请求注销用户会话。
- SSO 认证中心删除顶级域名下的共享 Cookie。
- 用户在其他应用（如应用 B）中再次访问时，由于共享 Cookie 已经被删除，用户需要重新登录。



### 基于JWT的SSO

JWT 可以跨不同域名进行传递，不受浏览器跨域限制，通过加密和签名技术，安全性较高

**用户访问应用 A**

- 用户通过浏览器访问应用 A（例如 `a.test.com`）。
- 应用 A 检测到用户没有登录，会将用户重定向到 SSO 认证中心（例如 `auth.test.com`）。

**重定向到 SSO 认证中心**

- 浏览器重定向到 SSO 认证中心。
- SSO 认证中心显示登录页面，用户输入用户名和密码进行登录。

**用户登录认证**

- SSO 认证中心验证用户提供的凭据（用户名和密码）。
- 如果认证成功，SSO 认证中心生成一个 JWT。JWT 通常包含用户标识、过期时间等信息，并通过签名算法进行签名。

**返回 JWT**

- SSO 认证中心将生成的 JWT 返回给用户，通常通过重定向的方式，将 JWT 附加在 URL 上（例如 `a.test.com?token=JWT`）。

**应用 A 验证 JWT**

- 用户携带 JWT 访问应用 A。
- 应用 A 读取并验证该 JWT，验证包括检查签名和过期时间。如果 JWT 有效，应用 A 知道用户已经通过认证，允许访问受保护的资源。
- 应用 A 可以选择将用户信息存储在服务器会话中，或者继续依赖该 JWT 进行用户身份验证。

**访问其他应用 B**

- 用户访问应用 B（例如 `b.test.com`），并携带 JWT。
- 应用 B 读取并验证该 JWT，确认用户已经通过认证，允许用户访问受保护的资源。

**用户登出**

- 用户在任何一个应用（如应用 A）中执行登出操作。
- 应用 A 将请求发送到 SSO 认证中心，请求注销用户会话。
- SSO 认证中心使 JWT 失效，用户在其他应用（如应用 B）中再次访问时，由于 JWT 无效，用户需要重新登录。



![image-20240702165627622](./assets/image-20240702165627622.png)